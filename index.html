<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>THUNDERBIRD BBS</title>
  <meta name="GENERATOR" content="THUNDERBIRD BBS (C) 1989">
  <link rel="stylesheet" href="core/styles.css">
  <style>
    body {
      background-color: #FFF;
      padding: 20px;
    }
    .bbs-terminal {
      font-family: "Monaco", monospace;
      white-space: pre-wrap;
      line-height: 1.2;
      animation: crt-flicker 0.1s infinite alternate;
    }
    @keyframes crt-flicker {
      0% { opacity: 0.9; }
      100% { opacity: 1; }
    }
    .message-area {
    font-family: "Courier New", monospace;
    white-space: pre;
    line-height: 1.1;
    font-size: 14px;
    letter-spacing: 0;
    overflow-x: hidden;
  }
    .ansi-bright { font-weight: bold; }
    .ansi-black { color: #000000; }
    .ansi-red { color: #FF0000; }
    .ansi-green { color: #00FF00; }
    .ansi-yellow { color: #FFFF00; }
    .ansi-blue { color: #0000FF; }
    .ansi-magenta { color: #FF00FF; }
    .ansi-cyan { color: #00FFFF; }
    .ansi-white { color: #FFFFFF; }
    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 
      50% { opacity: 0; }
    }
  </style>
</head>
<body>

  <!-- Modem Connection Sequence -->
  <div id="modem-sequence" style="position:fixed;top:0;left:0;width:100%;height:100%;background:black;color:#00FF00;font-family:monospace;padding:20px;z-index:9999;">
    <div id="modem-text"></div>
  </div>

  <!-- BBS Interface -->
  <div id="bbs-interface" class="window" style="width: 600px; margin: 0 auto; display:none;">
    <div class="title-bar">
      <button aria-label="Close" class="close"></button>
      <h1 class="title">THUNDERBIRD BBS</h1>
      <button aria-label="Resize" class="resize"></button>
    </div>
    <div class="separator"></div>

    <ul role="menu-bar">
      <li role="menu-item" tabindex="0" aria-haspopup="true">
        File
        <ul role="menu">
          <li role="menu-item"><a href="#login">Login</a></li>
          <li role="menu-item"><a href="#register">Register</a></li>
          <li role="menu-item" class="divider"></li>
          <li role="menu-item"><a href="#exit">Exit</a></li>
        </ul>
      </li>
      <li role="menu-item" tabindex="0" aria-haspopup="true">
        Messages
        <ul role="menu">
          <li role="menu-item"><a href="#new">New Post</a></li>
          <li role="menu-item"><a href="#inbox">Inbox</a></li>
        </ul>
      </li>
    </ul>

    <div class="window-pane bbs-terminal message-area" id="message-display">
<pre>
	
   ■  ▐▌█  ▐▌▄▄▄▄     ▐▌▗▞▀▚▖ ▄▄▄ ▗▖   ▄  ▄▄▄ ▐▌
▗▄▟▙▄▖▐▌▀▄▄▞▘█   █    ▐▌▐▛▀▀▘█    ▐▌   ▄ █    ▐▌
  ▐▌  ▐▛▀▚▖  █   █ ▗▞▀▜▌▝▚▄▄▖█    ▐▛▀▚▖█ █ ▗▞▀▜▌
  ▐▌  ▐▌ ▐▌        ▝▚▄▟▌          ▐▙▄▞▘█   ▝▚▄▟▌
  ▐▌                                        
           ┌───────────────────────┐
           │ NO FEDS // NO COWARDS │
           └───────────────────────┘
    </pre></div>

    <div class="separator"></div>
    <div class="window-pane">
      <div class="field-row" style="margin-top: 10px;">
        <label for="bbs-command">COMMAND:</label>
        <input id="bbs-command" type="text" style="flex-grow: 1;" placeholder="Type HELP">
      </div>
      <div class="field-row" style="justify-content: flex-end; margin-top: 10px;">
        <button class="btn">CLEAR</button>
        <button class="btn btn-default">SEND</button>
      </div>
    </div>
  </div>

<script>
// ======================
// ANSI PROCESSOR (KEEP THIS)
// ======================
function processANSI(text) {
  return text
    .replace(/\x1B\[1m/g, '<span class="ansi-bright">')
    .replace(/\x1B\[0m/g, '</span>')
    .replace(/\x1B\[1;30m/g, '<span class="ansi-black">')
    .replace(/\x1B\[1;31m/g, '<span class="ansi-red">')
    .replace(/\x1B\[1;32m/g, '<span class="ansi-green">')
    .replace(/\x1B\[1;33m/g, '<span class="ansi-yellow">')
    .replace(/\x1B\[1;34m/g, '<span class="ansi-blue">')
    .replace(/\x1B\[1;35m/g, '<span class="ansi-magenta">')
    .replace(/\x1B\[1;36m/g, '<span class="ansi-cyan">')
    .replace(/\x1B\[1;37m/g, '<span class="ansi-white">');
}

// ======================
// FIXED RAINBOW BANNER
// ======================
function createRainbowBanner() {
  // Use backticks (`) to preserve exact whitespace
  const asciiArt = 
`   ■  ▐▌█  ▐▌▄▄▄▄     ▐▌▗▞▀▚▖ ▄▄▄ ▗▖   ▄  ▄▄▄ ▐▌
  ▗▄▟▙▄▖▐▌▀▄▄▞▘█   █    ▐▌▐▛▀▀▘█    ▐▌   ▄ █    ▐▌
    ▐▌  ▐▛▀▚▖  █   █ ▗▞▀▜▌▝▚▄▄▖█    ▐▛▀▚▖█ █ ▗▞▀▜▌
    ▐▌  ▐▌ ▐▌        ▝▚▄▟▌          ▐▙▄▞▘█   ▝▚▄▟▌
    ▐▌                                          `;

  const colors = ['\x1B[1;31m', '\x1B[1;33m', '\x1B[1;32m', 
                 '\x1B[1;36m', '\x1B[1;34m', '\x1B[1;35m'];
  let colorIndex = 0;

  // Process each line separately
  let rainbowArt = '';
  const lines = asciiArt.split('\n');
  
  for (let line of lines) {
    // Skip empty lines
    if (!line.trim()) continue;
    
    // Center each line
    const padAmount = Math.floor((60 - line.length) / 2); // 60 = max width
    line = ' '.repeat(padAmount) + line;
    
    // Apply rainbow colors
    let coloredLine = '';
    for (const char of line) {
      if (char === ' ') {
        coloredLine += ' ';
      } else {
        coloredLine += colors[colorIndex % colors.length] + char + '\x1B[0m';
        colorIndex++;
      }
    }
    rainbowArt += coloredLine + '<br>';
  }

  // Add centered welcome box
  rainbowArt += `
  <div style="text-align:center;margin-top:10px">
    ┌───────────────────────┐<br>
    │ NO FEDS / NO COWARDS  │<br>
    └───────────────────────┘
  </div>`;

  return rainbowArt;
}


// ======================
// MODEM SEQUENCE (FULLY WORKING VERSION)
// ======================
function startModemSequence() {
  const modemText = document.getElementById('modem-text');
  const modemSequence = [
    "ATZ",
    "OK",
    "ATDT555-1234",
    "CONNECT 2400",
    "NEGOTIATING PROTOCOL...",
    "HANDSHAKE COMPLETE",
    "LOGGING INTO SYSTEM...",
    '\x1B[1;32mCONNECTION ESTABLISHED\x1B[0m'
  ];

  let step = 0;
  function nextStep() {
    if (step < modemSequence.length) {
      modemText.innerHTML += processANSI(modemSequence[step]) + "<br>";
      step++;
      setTimeout(nextStep, 800);
    } else {
      document.getElementById('modem-sequence').style.display = 'none';
      document.getElementById('bbs-interface').style.display = 'block';
      document.getElementById('message-display').innerHTML = 
        processANSI(createRainbowBanner());
    }
  }
  nextStep();
}

// ======================
// START EVERYTHING WHEN PAGE LOADS
// ======================
window.onload = function() {
  setTimeout(startModemSequence, 500);
};

// ======================
// BBS COMMAND HANDLER
// ======================
let currentSessionId = null;
const commandInput = document.getElementById('bbs-command');
const messageDisplay = document.getElementById('message-display'); // Changed from querySelector to getElementById for consistency
const sendButton = document.querySelector('.btn.btn-default');
const clearButton = document.querySelector('.btn:not(.btn-default)');

async function sendCommandToServer(commandValue) {
  if (!commandValue.trim()) return;

  // Display command in terminal
  messageDisplay.innerHTML += `\n&gt; ${commandValue}\n`;

  try {
    // Ensure this URL matches the Express API server's host and port
    const apiUrl = 'http://localhost:3001/api/command';
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ command: commandValue, sessionId: currentSessionId }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      messageDisplay.innerHTML += `Error: ${response.status} ${errorText}\n`;
      messageDisplay.scrollTop = messageDisplay.scrollHeight;
      return;
    }

    const data = await response.json();
    currentSessionId = data.sessionId;
    // Ensure data.response is treated as pre-formatted text
    // To prevent HTML injection and preserve formatting like newlines
    const responseTextNode = document.createTextNode(data.response);
    messageDisplay.appendChild(responseTextNode);
    
  } catch (error) {
    console.error('Fetch error:', error);
    messageDisplay.innerHTML += `\nError connecting to server: ${error.message}\n`;
  } finally {
    commandInput.value = '';
    messageDisplay.scrollTop = messageDisplay.scrollHeight;
  }
}

commandInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault(); // Prevent default form submission if it's part of a form
    sendCommandToServer(this.value);
  }
});

sendButton.addEventListener('click', function() {
  sendCommandToServer(commandInput.value);
});

// Clear button functionality
clearButton.addEventListener('click', function() {
  messageDisplay.innerHTML = processANSI(createRainbowBanner());
  // Optionally, you might want to clear the session or inform the server
  // For now, just clears the display
});
</script>
</body>
</html>
